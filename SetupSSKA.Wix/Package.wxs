<?xml version="1.0" encoding="UTF-8"?>

<!--
  SSKA Analyzer Installer
  Built with WiX Toolset v5

  Prerequisites: Build WpfApplication1 first with MSBuild:
    msbuild ..\WpfApplication1\WpfApplication1.csproj /p:Configuration=Release

  Then build this installer:
    dotnet build SetupSSKA.Wix.wixproj -c Release

  Output: bin\Release\x64\SetupSSKA.Wix.msi
-->

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package
    Name="SSKA Analyzer"
    Manufacturer="V_Zdravkov"
    Version="2.1.0"
    UpgradeCode="E8F5B9A1-7C3D-4E2F-9A1B-5C8D7E6F4A3B"
    Scope="perMachine">

    <!-- Upgrade handling for current installer versions -->
    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed."
      AllowSameVersionUpgrades="yes"
      Schedule="afterInstallInitialize" />

    <!-- Detect old Visual Studio Deployment Project installer (different UpgradeCode) -->
    <Upgrade Id="D0D9764A-E258-44BD-B847-E93BAA658CC7">
      <UpgradeVersion Minimum="0.0.0" IncludeMinimum="yes" Maximum="99.0.0" IncludeMaximum="yes"
                      Property="OLDVERSIONFOUND" MigrateFeatures="yes" />
    </Upgrade>

    <!-- Application icon in Add/Remove Programs -->
    <Icon Id="AppIcon.ico" SourceFile="..\WpfApplication1\IconSSKAapp.ico" />
    <Icon Id="DataIcon.ico" SourceFile="..\WpfApplication1\IconSSKAdata.ico" />
    <Property Id="ARPPRODUCTICON" Value="AppIcon.ico" />

    <!-- UI Extension - FeatureTree allows users to select optional features -->
    <ui:WixUI Id="WixUI_FeatureTree" />

    <!-- License/info text explaining what will be installed -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <!-- Installation directory structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="SSKAanalyzer" />
    </StandardDirectory>

    <!-- Program Menu shortcut (All Users) -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="SSKA Analyzer" />
    </StandardDirectory>

    <!-- Desktop shortcuts -->
    <StandardDirectory Id="DesktopFolder" />

    <!-- User Documents folder for MySSKA data -->
    <StandardDirectory Id="PersonalFolder">
      <Directory Id="MySSKAFolder" Name="MySSKA">
        <Directory Id="ArxivFolder" Name="Arxiv" />
        <Directory Id="CategorizationUserFolder" Name="Categorization">
          <Directory Id="ImageFormatsFolder" Name="imageformats" />
          <Directory Id="PlatformsFolder" Name="platforms" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Main application files -->
    <ComponentGroup Id="MainApplication" Directory="INSTALLFOLDER">
      <!-- Main executable and config -->
      <Component Id="MainExecutable">
        <File Id="SSKAanalyzer.exe" Source="..\WpfApplication1\bin\Release\SSKAanalyzer.exe" KeyPath="yes" />
      </Component>
      <Component Id="AppConfig">
        <File Source="..\WpfApplication1\bin\Release\SSKAanalyzer.exe.config" />
      </Component>

      <!-- Project DLLs -->
      <Component Id="SimpleSecurity">
        <File Source="..\WpfApplication1\bin\Release\SimpleSecurity.dll" />
      </Component>
      <Component Id="CategoryFormatter">
        <File Source="..\WpfApplication1\bin\Release\CategoryFormatter.dll" />
      </Component>
      <Component Id="DataVisualization">
        <File Source="..\WpfApplication1\bin\Release\DotNetProjects.DataVisualization.Toolkit.dll" />
      </Component>

      <!-- Microsoft.Bcl -->
      <Component Id="MsBclAsyncInterfaces">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Bcl.AsyncInterfaces.dll" />
      </Component>

      <!-- Microsoft.Extensions.Configuration -->
      <Component Id="MsExtConfig">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Configuration.dll" />
      </Component>
      <Component Id="MsExtConfigAbs">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Configuration.Abstractions.dll" />
      </Component>
      <Component Id="MsExtConfigBinder">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Configuration.Binder.dll" />
      </Component>
      <Component Id="MsExtConfigCommandLine">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Configuration.CommandLine.dll" />
      </Component>
      <Component Id="MsExtConfigEnvVars">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Configuration.EnvironmentVariables.dll" />
      </Component>
      <Component Id="MsExtConfigFileExt">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Configuration.FileExtensions.dll" />
      </Component>
      <Component Id="MsExtConfigJson">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Configuration.Json.dll" />
      </Component>
      <Component Id="MsExtConfigUserSecrets">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Configuration.UserSecrets.dll" />
      </Component>

      <!-- Microsoft.Extensions.DependencyInjection -->
      <Component Id="MsExtDI">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.DependencyInjection.dll" />
      </Component>
      <Component Id="MsExtDIAbs">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.DependencyInjection.Abstractions.dll" />
      </Component>

      <!-- Microsoft.Extensions.Diagnostics -->
      <Component Id="MsExtDiagnostics">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Diagnostics.dll" />
      </Component>
      <Component Id="MsExtDiagnosticsAbs">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Diagnostics.Abstractions.dll" />
      </Component>

      <!-- Microsoft.Extensions.FileProviders -->
      <Component Id="MsExtFileProvidersAbs">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.FileProviders.Abstractions.dll" />
      </Component>
      <Component Id="MsExtFileProvidersPhysical">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.FileProviders.Physical.dll" />
      </Component>
      <Component Id="MsExtFileSystemGlobbing">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.FileSystemGlobbing.dll" />
      </Component>

      <!-- Microsoft.Extensions.Hosting -->
      <Component Id="MsExtHosting">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Hosting.dll" />
      </Component>
      <Component Id="MsExtHostingAbs">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Hosting.Abstractions.dll" />
      </Component>

      <!-- Microsoft.Extensions.Logging -->
      <Component Id="MsExtLogging">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Logging.dll" />
      </Component>
      <Component Id="MsExtLoggingAbs">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Logging.Abstractions.dll" />
      </Component>
      <Component Id="MsExtLoggingConfig">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Logging.Configuration.dll" />
      </Component>
      <Component Id="MsExtLoggingConsole">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Logging.Console.dll" />
      </Component>
      <Component Id="MsExtLoggingDebug">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Logging.Debug.dll" />
      </Component>
      <Component Id="MsExtLoggingEventLog">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Logging.EventLog.dll" />
      </Component>
      <Component Id="MsExtLoggingEventSource">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Logging.EventSource.dll" />
      </Component>

      <!-- Microsoft.Extensions.Options -->
      <Component Id="MsExtOptions">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Options.dll" />
      </Component>
      <Component Id="MsExtOptionsConfigExt">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Options.ConfigurationExtensions.dll" />
      </Component>
      <Component Id="MsExtPrimitives">
        <File Source="..\WpfApplication1\bin\Release\Microsoft.Extensions.Primitives.dll" />
      </Component>

      <!-- System DLLs -->
      <Component Id="SysBuffers">
        <File Source="..\WpfApplication1\bin\Release\System.Buffers.dll" />
      </Component>
      <Component Id="SysDiagnosticsDiagnosticSource">
        <File Source="..\WpfApplication1\bin\Release\System.Diagnostics.DiagnosticSource.dll" />
      </Component>
      <Component Id="SysIOPipelines">
        <File Source="..\WpfApplication1\bin\Release\System.IO.Pipelines.dll" />
      </Component>
      <Component Id="SysMemory">
        <File Source="..\WpfApplication1\bin\Release\System.Memory.dll" />
      </Component>
      <Component Id="SysNumericsVectors">
        <File Source="..\WpfApplication1\bin\Release\System.Numerics.Vectors.dll" />
      </Component>
      <Component Id="SysRuntimeUnsafe">
        <File Source="..\WpfApplication1\bin\Release\System.Runtime.CompilerServices.Unsafe.dll" />
      </Component>
      <Component Id="SysTextEncodingCodePages">
        <File Source="..\WpfApplication1\bin\Release\System.Text.Encoding.CodePages.dll" />
      </Component>
      <Component Id="SysTextEncodingsWeb">
        <File Source="..\WpfApplication1\bin\Release\System.Text.Encodings.Web.dll" />
      </Component>
      <Component Id="SysTextJson">
        <File Source="..\WpfApplication1\bin\Release\System.Text.Json.dll" />
      </Component>
      <Component Id="SysThreadingTasksExt">
        <File Source="..\WpfApplication1\bin\Release\System.Threading.Tasks.Extensions.dll" />
      </Component>
      <Component Id="SysValueTuple">
        <File Source="..\WpfApplication1\bin\Release\System.ValueTuple.dll" />
      </Component>
    </ComponentGroup>

    <!-- Categorization tools (installed to user Documents folder for editability) -->
    <ComponentGroup Id="CategorizationTools" Directory="CategorizationUserFolder">
      <Component Id="Categorizer" Guid="A1B2C3D4-1111-4E5F-A1B2-000000000001">
        <File Id="Categorizer.exe" Source="..\Categorization\Categorizer.exe" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer\Files"
                       Name="Categorizer" Type="string" Value="[CategorizationUserFolder]Categorizer.exe" KeyPath="yes" />
      </Component>
      <!-- NeverOverwrite preserves user's customized categories on upgrade -->
      <Component Id="CategorizationCSV" Guid="A1B2C3D4-2222-4E5F-A1B2-000000000002" NeverOverwrite="yes">
        <File Id="Categorization.csv" Source="..\Categorization\Categorization.csv" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer\Files"
                       Name="CategorizationCSV" Type="string" Value="[CategorizationUserFolder]Categorization.csv" KeyPath="yes" />
      </Component>
      <!-- Qt Core DLLs -->
      <Component Id="Qt5Core" Guid="A1B2C3D4-3333-4E5F-A1B2-000000000003">
        <File Source="..\Categorization\Qt5Core.dll" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer\Files"
                       Name="Qt5Core" Type="integer" Value="1" KeyPath="yes" />
      </Component>
      <Component Id="Qt5Gui" Guid="A1B2C3D4-4444-4E5F-A1B2-000000000004">
        <File Source="..\Categorization\Qt5Gui.dll" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer\Files"
                       Name="Qt5Gui" Type="integer" Value="1" KeyPath="yes" />
      </Component>
      <Component Id="Qt5Widgets" Guid="A1B2C3D4-5555-4E5F-A1B2-000000000005">
        <File Source="..\Categorization\Qt5Widgets.dll" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer\Files"
                       Name="Qt5Widgets" Type="integer" Value="1" KeyPath="yes" />
      </Component>
      <Component Id="CategorizationFolderComponent">
        <CreateFolder />
        <RemoveFolder Id="RemoveCategorizationFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer"
                       Name="categorizationFolder" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Qt imageformats plugins (in user Categorization folder) -->
    <ComponentGroup Id="QtImageFormats" Directory="ImageFormatsFolder">
      <Component Id="qgif" Guid="A1B2C3D4-6666-4E5F-A1B2-000000000006">
        <File Source="..\Categorization\imageformats\qgif.dll" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer\Files"
                       Name="qgif" Type="integer" Value="1" KeyPath="yes" />
      </Component>
      <Component Id="qico" Guid="A1B2C3D4-7777-4E5F-A1B2-000000000007">
        <File Source="..\Categorization\imageformats\qico.dll" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer\Files"
                       Name="qico" Type="integer" Value="1" KeyPath="yes" />
      </Component>
      <Component Id="qjpeg" Guid="A1B2C3D4-8888-4E5F-A1B2-000000000008">
        <File Source="..\Categorization\imageformats\qjpeg.dll" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer\Files"
                       Name="qjpeg" Type="integer" Value="1" KeyPath="yes" />
      </Component>
      <Component Id="ImageFormatsFolderComponent">
        <CreateFolder />
        <RemoveFolder Id="RemoveImageFormatsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer"
                       Name="imageFormatsFolder" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Qt platforms plugins (in user Categorization folder) -->
    <ComponentGroup Id="QtPlatforms" Directory="PlatformsFolder">
      <Component Id="qwindows" Guid="A1B2C3D4-9999-4E5F-A1B2-000000000009">
        <File Source="..\Categorization\platforms\qwindows.dll" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer\Files"
                       Name="qwindows" Type="integer" Value="1" KeyPath="yes" />
      </Component>
      <Component Id="PlatformsFolderComponent">
        <CreateFolder />
        <RemoveFolder Id="RemovePlatformsFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer"
                       Name="platformsFolder" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Program Menu Shortcuts -->
    <ComponentGroup Id="Shortcuts" Directory="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut">
        <Shortcut Id="AppStartMenuShortcut"
                  Name="SSKA Analyzer"
                  Description="Personal Finance Analyzer"
                  Target="[INSTALLFOLDER]SSKAanalyzer.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="AppIcon.ico" />
        <RemoveFolder Id="CleanUpShortcutFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer"
                       Name="installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Desktop Shortcuts -->
    <ComponentGroup Id="DesktopShortcuts" Directory="DesktopFolder">
      <Component Id="DesktopAppShortcut">
        <Shortcut Id="DesktopAppShortcut"
                  Name="SSKA"
                  Description="SSKA Analyzer - Personal Finance"
                  Target="[INSTALLFOLDER]SSKAanalyzer.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="AppIcon.ico" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer"
                       Name="desktopShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>
      <Component Id="DesktopDataShortcut">
        <Shortcut Id="DesktopDataShortcut"
                  Name="SSKA Storage"
                  Description="SSKA Data Folder"
                  Target="[MySSKAFolder]"
                  Icon="DataIcon.ico" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer"
                       Name="dataShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- MySSKA Data Folder Structure (RemoveFolder only removes if empty - preserves user data) -->
    <ComponentGroup Id="DataFolders" Directory="MySSKAFolder">
      <Component Id="MySSKAFolderComponent">
        <CreateFolder />
        <RemoveFolder Id="RemoveMySSKAFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer"
                       Name="dataFolder" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    <ComponentGroup Id="ArxivFolderGroup" Directory="ArxivFolder">
      <Component Id="ArxivFolderComponent">
        <CreateFolder />
        <RemoveFolder Id="RemoveArxivFolder" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\VZdravkov\SSKAanalyzer"
                       Name="arxivFolder" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Feature definitions -->
    <Feature Id="MainFeature" Title="SSKA Analyzer" Description="Main application files (required)" Level="1" AllowAbsent="no">
      <ComponentGroupRef Id="MainApplication" />
      <ComponentGroupRef Id="Shortcuts" />
    </Feature>

    <Feature Id="DataFoldersFeature" Title="Data Folders" Description="Creates MySSKA folder in Documents with Arxiv (data) and Categorization (tools) subfolders" Level="1" AllowAbsent="no">
      <ComponentGroupRef Id="DataFolders" />
      <ComponentGroupRef Id="ArxivFolderGroup" />
      <ComponentGroupRef Id="CategorizationTools" />
      <ComponentGroupRef Id="QtImageFormats" />
      <ComponentGroupRef Id="QtPlatforms" />
    </Feature>

    <Feature Id="DesktopShortcutsFeature" Title="Desktop Shortcuts" Description="Creates SSKA and SSKA Storage shortcuts on the desktop" Level="1" AllowAbsent="yes">
      <ComponentGroupRef Id="DesktopShortcuts" />
    </Feature>

  </Package>
</Wix>
